# í¬íŒ… ë§¤ë‰´ì–¼

- [í¬íŒ… ë§¤ë‰´ì–¼](#í¬íŒ…-ë§¤ë‰´ì–¼)
  - [1. í…ŒìŠ¤íŠ¸ í™˜ê²½](#1-í…ŒìŠ¤íŠ¸-í™˜ê²½)
  - [2. Requirements](#2-requirements)
  - [3. ë¹Œë“œ ë° ì‹¤í–‰](#3-ë¹Œë“œ-ë°-ì‹¤í–‰)
    - [3-1. ë°±ì—”ë“œ ì„œë²„](#3-1-ë°±ì—”ë“œ-ì„œë²„)
      - [ë£¨íŠ¸ .env íŒŒì¼](#ë£¨íŠ¸-env-íŒŒì¼)
      - [SSL ì„¤ì •](#ssl-ì„¤ì •)
      - [ë¹Œë“œ ë° ì„œë²„ ì‹¤í–‰](#ë¹Œë“œ-ë°-ì„œë²„-ì‹¤í–‰)
    - [3-2. í•˜ë“œì›¨ì–´](#3-2-í•˜ë“œì›¨ì–´)
      - [.env íŒŒì¼](#env-íŒŒì¼)
      - [ìŒì„±ì¸ì‹ ì„¤ì •](#ìŒì„±ì¸ì‹-ì„¤ì •)
      - [ìì„¸ì¸ì‹ ì„¤ì •](#ìì„¸ì¸ì‹-ì„¤ì •)
      - [ìŠ¤ë§ˆíŠ¸ì‹±ìŠ¤ ì„¤ì •](#ìŠ¤ë§ˆíŠ¸ì‹±ìŠ¤-ì„¤ì •)
      - [ë””ìŠ¤í”Œë ˆì´ í”„ë¡ íŠ¸ì—”ë“œ ì„¤ì •](#ë””ìŠ¤í”Œë ˆì´-í”„ë¡ íŠ¸ì—”ë“œ-ì„¤ì •)

## 1. í…ŒìŠ¤íŠ¸ í™˜ê²½

- AWS EC2
- Ubuntu 20.04 LTS
- Raspberry Pi 4
- USB Webcam
- USB Mic
- LCD Display (1024x600)

## 2. Requirements

- Docker >= 20.10.0
- Mosquitto >= 2.0.15
  - with TLS encryption, port 8883
- RPi4
  - Python == 3.7.3
  - OpenCV == 4.6.0
  - cvlib == 0.2.7
  - dlib == 19.24.0
  - tensorflow == 2.4.0
  - google-cloud-speech == 2.16.2
  - pvporcupine == 2.1.4
  - pvrecorder == 1.1.1
  - NodeJS

## 3. ë¹Œë“œ ë° ì‹¤í–‰

### 3-1. ë°±ì—”ë“œ ì„œë²„

#### ë£¨íŠ¸ .env íŒŒì¼

ë¹Œë“œ ë° ìš´ì˜ì— ê´€ì—¬í•˜ëŠ” ëª¨ë“  ì‹œí¬ë¦¿ ì •ë³´ê°€ ë‹´ê¸´ íŒŒì¼

- .env.templateë¥¼ .envë¡œ ë³µì‚¬í•œ í›„ ë‚´ìš©ì„ ì‘ì„±
  - `SERVICE_HOST`: ì„œë¹„ìŠ¤ì˜ ë„ë©”ì¸ ì£¼ì†Œ (ie. j7a704.p.ssafy.io)
  - `MYSQL_###`: MariaDB ê´€ë ¨ ë³€ìˆ˜
    - `MYSQL_HOST`: ë¹ŒíŠ¸ì¸ MariaDBë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ê¸°ë³¸ê°’ dbë¥¼ ìœ ì§€í•´ì•¼ í•¨ (docker-compose.ymlì— ì •ì˜ë¨)
  - `OAUTH2_###`: ì†Œì…œë¡œê·¸ì¸ì„ ìœ„í•œ ID, SECRET
    - [Google](https://console.cloud.google.com/)
    - [Kakao](https://developers.kakao.com/)
  - `LOGIN_###`: ë¡œê·¸ì¸ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë  ì£¼ì†Œ
    - `LOGIN_SCHEME`: http ë˜ëŠ” https
    - `LOGIN_HOST`: {SERVICE_HOST}ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
  - `BROKER_URL`, `BASE_TOPIC`: MQTT ê´€ë ¨ ì„¤ì •
    - `BROKER_URL`: MQTT ì„œë²„ì˜ URL (TLSë¥¼ ì‚¬ìš©í•  ê²½ìš° ssl://ë¡œ ì‹œì‘)
    - `BASE_TOPIC`: ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•  MQTT Topic

#### SSL ì„¤ì •

- docker-compose.yml ìˆ˜ì •
  - `nginx:` ë¸”ë¡ì˜ `volumes:` {cert_path}:/etc/letsencrypt í˜•íƒœë¡œ ìˆ˜ì •
- nginx/nginx.conf.template ìˆ˜ì •
  - `ssl_certificate` ë° `ssl_certificate_key`ë¥¼ ì•Œë§ê²Œ ì„¤ì • (ê¸°ë³¸ê°’: `/etc/letsencrypt/live/${SERVICE_HOST}/...`)

#### ë¹Œë“œ ë° ì„œë²„ ì‹¤í–‰

```bash
$ cd {PROJECT_ROOT}
$ docker compose up -d --build
```

### 3-2. í•˜ë“œì›¨ì–´

#### .env íŒŒì¼

- `hw/.env.template`ì„ `hw/.env`ë¡œ ë³µì‚¬ í›„ ë‚´ìš©ì„ ì‘ì„±
  - WEBSOCKET_PORT : ì‚¬ìš©í•  ì›¹ì†Œì¼“ port ë²ˆí˜¸
  - MQTT_HOST : MQTT ì„œë²„ì˜ ì›¹ ì£¼ì†Œ
  - MQTT_PORT : MQTT port ë²ˆí˜¸
  - MQTT_BASE_TOPIC : MQTTì˜ BASE ì£¼ì œ
  - DEVICE_ID : ë¼ì¦ˆë² ë¦¬íŒŒì´ì˜ ì‹œë¦¬ì–¼ ë²ˆí˜¸ (`cat /proc/cpuinfo | grep Serial | awk '{print $3}'`)
  - PICOVOICE_KEY : [Picovoice ì‚¬ì´íŠ¸](https://console.picovoice.ai/)ì—ì„œ ë¡œê·¸ì¸ í›„ ì–»ì€ ACCESS KEY
  - KEYWORDS_PATH : ì‚¬ìš©í•  wakeup word ppn íŒŒì¼ ê²½ë¡œ
  - MODEL_PATH : ì‚¬ìš©í•  wakeup wordì˜ ì–¸ì–´ pv íŒŒì¼ ê²½ë¡œ
  - AUDIO_INDEX : USB ë§ˆì´í¬ê°€ ì¥ì°©ëœ audio index
    - `./Voice-recognition/show_audio.py` ì‹¤í–‰ì‹œí‚¤ê¸°
    - ì‚¬ìš©ì¤‘ì¸ ë§ˆì´í¬ ëª…ì— ì¼ì¹˜í•˜ëŠ” audio index í™•ì¸
  - RECORD_PATH : ë…¹ìŒ í›„ ì €ì¥ë˜ëŠ” ê²½ë¡œ, ì–´ëŠ ê²½ë¡œë“  ìƒê´€ì—†ìŒ

#### ìŒì„±ì¸ì‹ ì„¤ì •

USB ë§ˆì´í¬ 1ê°œë¥¼ ì´ìš©í•˜ì—¬ wakeup wordì™€ google sttë¥¼ ì´ìš©í•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥

1. Picovoice ì„¤ì •
   "í•˜ì´ ë¹…ìŠ¤ë¹„"ì™€ ê°™ì€ wakeup word ì„¤ì •

   - [Picovoice ì‚¬ì´íŠ¸](https://console.picovoice.ai/)ì—ì„œ ë¡œê·¸ì¸ í›„ `Access Token` ë°œê¸‰
   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

     ```sh
     pip3 install pvporcupinedemo
     pip3 install pvrecorder
     ```

   - í…ŒìŠ¤íŠ¸

     `hw/Voice-recogntion/Test_Code/porcupine_demo_mic`ë¥¼ í†µí•´
     ë§Œë“¤ì–´ë‘” ë³¸ì¸ì˜ access_keyë¥¼ ë„£ê³  ì‹¤í–‰

     ```sh
     porcupine_demo_mic --access_key ${ACCESS_KEY} --keywords picovoice
     ```

     picovoiceë¼ê³  ë§ˆì´í¬ì— ë§ í–ˆì„ ë•Œ, Hotword detectedë¼ëŠ” ë©”ì„¸ì§€ ì¶œë ¥í•˜ë©´ ì •ìƒ

2. Google STT ì„¤ì •

   - `í”„ë¡œì íŠ¸ ìƒì„± > ì„œë¹„ìŠ¤ ê³„ì • & Access í‚¤(.json íŒŒì¼) ë°œê¸‰` [ì°¸ê³  ì‚¬ì´íŠ¸](https://cloud.google.com/speech-to-text/docs/before-you-begin#windows)
   - ìƒì„±í•œ Access í‚¤(.json íŒŒì¼)ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •

     ```conf
     GOOGLE_APPLICATION_CREDENTIALS="KEY_PATH"
     ```

   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

     ```sh
     pip3 install --upgrade google-cloud-speech
     pip3 uninstall grpcio
     pip3 uninstall grpcio-status
     pip3 install grpcio==1.44.0 --no-binary=grpcio
     pip3 install grpcio-tools==1.44.0 --no-binary=grpcio-tools
     ```

   - í…ŒìŠ¤íŠ¸

     `hw/Voice-recogntion/Test_Code/google_stt_test.py`ë¥¼ ì‹¤í–‰

     ```sh
     python3 google_stt_test.py
     ```

     `Transcript: how old is the Brooklyn Bridge` ì¶œë ¥ ì‹œ ì •ìƒ

#### ìì„¸ì¸ì‹ ì„¤ì •

OpenCVì™€ Tensorflowë¥¼ ì´ìš©í•˜ì—¬ USB ì¹´ë©”ë¼ì— ì°íŒ ì‚¬ì§„ì„ í†µí•´ ìì„¸ ì¸ì‹

1. OpenCV ì„¤ì •

   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

     ```sh
     pip3 install opencv-contrib-python==4.1.0.25
     ```

   - í…ŒìŠ¤íŠ¸

     ```sh
     python3 -c "import cv2; print(cv2.__version__)"
     ```

     ì—ëŸ¬ ì—†ì„ ì‹œ ì •ìƒ

2. dlib ì„¤ì •

   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

     ```sh
     pip3 install dlib
     ```

   - í…ŒìŠ¤íŠ¸

     ```sh
     python3 -c "import dlib; print(dlib.__version__)"
     ```

     ì—ëŸ¬ ì—†ì„ ì‹œ ì •ìƒ

3. cvlib ì„¤ì •

   - ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

     ```sh
     pip3 install cvlib
     pip3 install <https://github.com/lhelontra/tensorflow-on-arm/releases/download/v2.1.0/tensorflow-2.1.0-cp37-none-linux_armv7l.whl>
     ```

   - í…ŒìŠ¤íŠ¸

     ```sh
     python3 -c "import cvlib; print(cvlib.__version__)"
     ```

     ì—ëŸ¬ ì—†ì„ ì‹œ ì •ìƒ

#### ìŠ¤ë§ˆíŠ¸ì‹±ìŠ¤ ì„¤ì •

- Install packages

- Build device library for smartThings

  ```sh
  cd ~/rpi-st-device
  ./sdkbuildsetup
  cd ~/st-device-sdk-c
  make
  ```

- Register Device in Developer Workspace

  1. Make device workspace
  2. Make device Profile and Onboarding
  3. Write Product info
  4. Create raspberry pi device key
  5. Enroll your device key into your SmartThings in workspace
  6. download Onboarding.json and copy into raspberryPi directory
  7. make qrcode for device

- Build your device

  ```sh
  cd ~/st-device-sdk-c/example
  rm example
  make
  ```

- Setting Raspberry Pi for AP mode

  - Check your Pi have AP mode
    ```sh
    iw phy0 info
    ```
  - Check if you have with Wifi(2.4GHz) in your Area

    - If there no Wifi(2.4GHz) you can't connect your device in your phone

  - Install packages for SoftAP services

    ```sh
    sudo apt-get install hostapd
    sudo apt-get install dnsmasq
    ```

  - Disable SoftAP service to prevent start without your purpose

    ```sh
    sudo systemctl unmask hostapd
    sudo update-rc.d hostapd disable
    sudo update-rc.d dnsmasq disable
    ```

  - Copy and change dhcpcd_ap code

    ```sh
    sudo cp /etc/dhcpcd.conf /etc/dhcpcd_ap.conf
    ```

    ```
    # /etc/dhcpcd_ap.conf

    interface wlan0
    static ip_address = 192.168.2.1/24
    nohook wpa_supplicant
    ```

  - Change hostapd.conf
    check your channel with `iw wlan0 info`

    ```conf
    # /etc/hostapd/hostapd.conf

    contry_code=KR
    interface=wlan0
    channel={channel}
    ```

  - Change code dnsmasq.conf

    ```conf
    # /etc/dnsmasq.conf

    interface=wlan0
    dhcp-range=192.168.2.2,192.168.2.10,255.255.255.0.12h
    domain=wlan
    address=/gw.wlan/192.168.2.1
    ```

  - Enable AP mode

    ```sh
    cd ~/rpi-st-device
    sudo ./testhostapd
    ```

- Connect your device in your phone application
  1. Use qrcode
  2. Find devices that can be registered nearby

#### ë””ìŠ¤í”Œë ˆì´ í”„ë¡ íŠ¸ì—”ë“œ ì„¤ì •

- í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë¹Œë“œ ë° ì‹¤í–‰

  ```sh
  cd front
  npm install
  npm run build
  npx live-server build --port=3000 --no-browser --entry-file=build/index.html
  ```

####  ì‹œì—° ì‹œë‚˜ë¦¬ì˜¤

ğŸ“… Google Calendar ì¼ì • í™•ì¸ ë° ì•Œë¦¼

![calendar](./front/screenshot/calendar.gif)

- ì„ë°•í•œ ì¼ì •(20ë¶„ ë‚´), ì§„í–‰ ì¤‘ì¸ ì¼ì •, ì˜¤ëŠ˜ì˜ ì¼ì • í™•ì¸ ê°€ëŠ¥
- ì„ë°•í•œ ì¼ì • ë°œìƒ ì‹œ, í˜ì´ì§€ê°€ ìë™ìœ¼ë¡œ ì´ë™ë˜ì–´ ë¹ ë¥¸ ë‚´ìš© í™•ì¸ ê°€ëŠ¥

ğŸ”Š ì—°ë™ëœ `Github` ê³„ì • ì•Œë¦¼ í™•ì¸

![github](./front/screenshot/noti.gif)

- ì½ì§€ ì•Šì€ ì•Œë¦¼ ë°œìƒ ì‹œ, í˜ì´ì§€ê°€ ìë™ìœ¼ë¡œ ì´ë™ë˜ì–´ ë¹ ë¥¸ ë‚´ìš© í™•ì¸ ê°€ëŠ¥
- ë‹¤ë¥¸ í˜ì´ì§€ ì´ë™ ì‹œ, ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬ ë° ìƒíƒœ ì—°ë™

ğŸ¥› ì‚¬ìš©ìì˜ ì¼ì¼ ë° ì£¼ê°„ `ìŒìˆ˜ëŸ‰` ì¶”ì´ í™•ì¸

![water](./front/screenshot/watermodal.gif)

- ìŒìˆ˜ ì‹œ ìŒìˆ˜ëŸ‰ í™•ì¸ ë° ì‹œê°„ëŒ€ë³„ ìŒìˆ˜ ì¶”ì´ í™•ì¸ ê°€ëŠ¥

![waterstatistics](./front/screenshot/watersta.gif)

- ìµœê·¼ 15ì¼ê°„ì˜ ì´ ìŒìˆ˜ëŸ‰ í™•ì¸ ê°€ëŠ¥

ğŸ™‹ğŸ¼â€â™‚ï¸ ì‚¬ìš©ìì˜ `ì•‰ì•„ìˆëŠ” ìì„¸` ì‹¤ì‹œê°„ í™•ì¸ í›„ ì ìˆ˜í™”

![capture](./front/screenshot/capture.gif)

- ìì„¸ ì¸¡ì • ì ìˆ˜ì˜ ê¸°ì¤€ì´ ë˜ëŠ” ì‚¬ì§„ì„ ì¸¡ì • ì „ì— ì´¬ì˜

![posture](./front/screenshot/posture.gif)

- ì¼ì •í•œ ê°„ê²©ìœ¼ë¡œ ìì„¸ ì ìˆ˜ë¥¼ ì¸¡ì •í•˜ì—¬ ì‹œê°í™”
- 71ì  ì´ìƒì¼ ê²½ìš° ì¢‹ì€ ìì„¸ë¡œ íŒë‹¨

![posturebad](./front/screenshot/posturebad.gif)

- 70ì  ì´í•˜ì¼ ê²½ìš° ì•ˆì¢‹ì€ ìì„¸ë¡œ íŒë‹¨í•˜ì—¬ ì•Œë¦¼ì„ í†µí•´ ìì„¸ êµì •ì„ ê¶Œê³ 

ğŸ§˜ğŸ¼ ì—…ë¬´ë„ ì‰¬ë©´ì„œ! `ìŠ¤íŠ¸ë ˆì¹­ ì •ë³´` ì œê³µ

![stretch](./front/screenshot/mic.gif)

- ìŒì„± ëª…ë ¹ì–´ë¥¼ í†µí•´ ì•½ 10ê°€ì§€ ìŠ¤íŠ¸ë ˆì¹­ ì •ë³´ ì œê³µ

â„ï¸ `Samsung Smart Things` ì—°ë™, ë¨¼ ê±°ë¦¬ ê¸°ê¸° ì¡°ì‘ ê°€ëŠ¥

![smartthings](./front/screenshot/smartthings.gif)

- ì‚¼ì„± SmartThings ìŠ¤í™ì— ë§ì¶”ì–´ ì„œë“œíŒŒí‹° ì œí’ˆìœ¼ë¡œ ì œì‘ë˜ì—ˆê¸° ë•Œë¬¸ì— ì‚¼ì„± SmartThings ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ í†µí•´ ì–¸ì œ ì–´ë””ì„œë“  ê¸°ê¸° ì¡°ì‘ì´ ê°€ëŠ¥